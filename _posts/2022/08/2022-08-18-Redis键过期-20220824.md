---
layout: post
title: 生存还是毁灭，Redis会怎么办！
tagline: by 揽月中人
categories: Redis
tags:
- 揽月中人
---

  

他非常犹豫，思考着：

To be, or not to be，that is the question！

《哈姆雷特》中的经典名句。

但是思索片刻，又会觉得与《心经》中【色即是空，空即是色】有类似的含义。

-------------------------------

当然扯远了，本篇我们还是说说Redis键的生存时间和生存策略，毁灭策略。

<!--more-->

### 1.前言

开端只是一个引文，不过有时候也值得大家去思考一番，下面进入正题。

下面分几个部分讲啦，先来回顾一下Redis键的生存时间，过期时间的设置；然后会讲到过期键删除策略，然后会聊其他功能对过期键的处理。



### 2.键的生存时间

键过期时间设置通过Expire命令或者Pexpire命令，客户端可以以毫秒级的精度为数据库中的某个键设置生存时间，一段时间后Redis服务器会删除生存时间为0的键。下面我们看一下Redis键的过期时间设置，以及查询键剩余寿命。

```shell
EXPIRE key 5 #设置一个键的过期时间 单位秒
EXPIREAT KEY 1660753861  #设置过期时间某个时间戳过期（UNIX时间戳）单位秒

PEXPIRE key 33 #设置一个键的过期时间 单位毫秒
PEXPIREAT key 1660839534000 #设置过期时间某个时间戳过期（UNIX时间戳）单位毫秒

TTL key  # 返回键的剩余过期时长，单位秒
PTTL key # 返回键的剩余过期时长，单位毫秒
```

Redis中的这些键的过期时间如何保存

Redis中维护了一个过期字典。其数据结构中，字典的键是一个指针，指向某个数据库键，而字典的键值则是一个long类型的整数，表示一个毫秒精度的UNIX时间戳。

其实上面几种设置键过期时间的命令相当于最后都是调用 PEXPIREAT 这个命令。



### 3.键的过期删除策略

#### 3.1 如何判定键过期

Redis中判断键是否过期会使用以下的方法

- 检查给定的键是否存在于过期字典，如果存在则获取键的过期时间
- 检查当前的UNIX时间戳是否大于键的过期时间戳，大于过期时间戳的话则判定键过期

#### 3.2 三种过期键删除策略

常见删除策略有三种，定时删除，惰性删除，定期删除

##### 3.2.1定时删除

定时删除是在设置键的过期时间时，设置一个定时器，定时器会在键的过期时间到来时立即删除键

- 优点： 内存友好，可以保证过期键尽可能快速地被删除，释放内存。
- 缺点： CPU资源分配不友好，如果过期键比较多的时候，此时删除会占用大量的CPU资源，从而间接影响Redis的性能。

##### 3.2.2惰性删除

惰性删除只会在程序需要使用键时，才会对当前键进行过期检查，而不会去删除其他的过期键。

- 优点：CPU资源耗费小，因为只是在取出键的时候才会做过期检查，并删除等操作。
- 缺点： 过期键会占用内存，如果一个过期键永远不被使用，那么就永远不能被删除，会造成内存泄漏。

惰性删除执行步骤如下：

1. 执行读写命令时去检查键的过期时间
2. 如果键过期，删除键，整个流程会按照键不存在的情况处理
3. 如果键未过期，则按照键存在的情况执行命令

##### 3.2.3定期删除

定期删除是每隔一段时间执行一次过期键删除操作，可以通过限制删除的操作执行的时长和频率来减少CPU资源占用。同时定期删除策略不会导致过期键过多的堆积，造成大量内存泄漏。

定期删除策略有两个点比较重要，执行时长和执行频率。 需要两者结合才能达到最优的效果。



定期删除步骤：

1. 从设置过期时间的key的集合中随机检查20个key
2. 删除其中的过期键。如果检查结果中25%以上的key过期，则开始新一轮任务。
3. 每次会按顺序在每个数据库执行，如果在3号数据库返回，则会记录下来，下次删除操作执行的时候会从4号数据库开始，就这样循环遍历整个Redis数据库。



定期任务执行频率：

为了定期检测资源和服务状态并根据预定策略执行相应的操作，Redis会调用内部函数来执行多种后台任务。

其执行频率由**hz**参数指定，默认为10，即每秒执行10次。

![image-20220821131302978](https://www.javanorth.cn/assets/images/2022/lyj/redis-key-01.png) 

这个值可以设置1-500，但是官方建议设置100以下，设置过大会造成CPU资源占用过大。基本上只用默认值就能满足大部分需求。

### 4.其他功能对过期键的处理

Redis数据保存有AOF和RDB两种功能。对于过期键的处理也不相同。

RDB持久化对过期键的处理：

- 生成RDB文件时。  过期key会被忽略，从而不会被保存到RDB文件中
- 加载RDB文件。
  - 主服务器模式。 载入RDB文件时，会对key的过期时间进行检查，过期键会被忽略，不会加载到Redis中
  - 从服务器模式。所有数据key都会加载到Redis中

AOF持久化对过期键的处理：

- AOF文件写入的时候，会append删除语句， DEL key 。
- AOF重写的时候过期key则不会被写入AOF文件中。



当Redis服务器处于复制模式时对过期键的处理：

- 主服务器删除key是，会向从服务器发送DEL命令
- 从服务器不会处理过期key
- 从服务器只有接到Master发送的DEL命令才会删除key

### 总结

Redis的可以过期策略采用惰性删除和定期删除两种组合方式，其中惰性删除保证过期键一点过不会被使用，定期删除可以保证过期数据得到释放，优化资源占用率。





 

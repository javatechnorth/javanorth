---
layout: post
title: 内存泄漏，简单又不简单
tagline: by 揽月中人
categories: Java
tags:
- 揽月中人
---

哈喽，大家好，我是指北君。  

Java内存泄漏一直Java程序中最常见的问题之一，它会导致内存溢出，最终导致程序崩溃。我们可能对内存泄漏很熟悉，但又不是那么熟悉，真的遇到事故的时候，内存泄漏问题排查起来却也没有那么容易。本篇就再次梳理一下Java内存泄漏的那些事。

<!--more-->

### 前言

使用Java编写程序时，我们使用new关键字创建对象。而且我们还不需要专门在对象使用完成后去释放其占用的内存，这是因为Java有专门的垃圾回收器来负责删除不需要的对象。只要不被使用的对象有垃圾回收器回收，那么程序会处于正常运行的状态，但是垃圾回收其无法删除那些不被使用的对象时，我们的Java程序则可能发生了内存泄漏。



### 内存泄漏是什么

内存泄漏指的是JVM中某些不再需要使用的对象，仍然存活于JVM中而不能及时释放而导致内存空间的浪费。Java中内存泄漏的原因有多种，这些众多的因素会导致Java程序产生不同类型的内存泄漏，随着时间的推移，内存泄漏会使程序增加额外的内存资源占用，从而导致程序性能下降。	

垃圾回收器会回收长时间没有引用的对象，但是它不会回收那些还存在引用的对象，这就是产生内存泄漏的原因。

所以为了防止内存泄漏，程序设计之初就需要考虑去释放那些不使用的内存空间，而开发人员也应当时刻考虑内存泄漏的可能性，并增加一些测试和检测避免内存泄漏。



### 堆和栈的内存泄漏

Java中，我们可能会遇到栈内存泄露和堆内存泄漏。

其中堆内存泄漏是由于创建后的对象一直存在于堆中，不再需要的对象其引用一直没有被移除。这些无用的对象会慢慢占用内存，最后导致内存溢出。

栈内存泄漏由于方法不断被调用，但是一直没有退出方法。这种情况可能发生在无限循环或递归掉用时，最终导致栈内存溢出。



### 内存泄漏的原因

Java中内存泄漏主要是因为不能正确释放不需要的资源，长生命周期对象持有短生命周期对象的引用。

- 静态字段

静态字段引起的内存泄漏比较常见，如果某个不需要的类中含有静态字段，那么就会造成内存泄漏。单例模式中如果持有其他的类引用就会造成内存泄漏，静态集合如HashMap，LinkedList等持有的一些对象没有及时释放等。

- Thread Local

threadlocal引用一个对象使用完成后并没有被及时remove掉，线程一直存活的情况下（使用线程池时）就会发生内存泄漏。

大多时候都是由于开发人员的代码错误导致的，要防止这种内存泄漏，就需要编写必要的代码来配合垃圾回收器释放资源。



### 避免Java内存泄漏的一些最佳实践

- 使用最新稳定版本的Java
- 尽量减少使用静态变量，使用完之后即使赋值 null，移除引用
- 明确对象的有效作用域，尽量缩小对象的作用域。局部变量回收会很快。
- 减少长生命周期对象持有短生命周期的引用
- 各种连接应该及时关闭（数据库连接，网络，IO等）
- 使用内存泄漏检测工具如MAT,Visual VM，jprofile 等
- 避免在代码中使用System.gc()
- 避免使用内部类



内存泄漏很难定位并修复，但是我们可以遵循以下几个步骤去定位并修复：

1. 确定是否存在内存泄漏，启用详细的GC跟踪。
2. 使用一些第三方插件进行分析（jprofile  Visual VM等
3. 检查调用堆栈是否有未释放的引用（分析GC状态）
4. 找出对象没有被垃圾回收的原因
5. 编写代码手动删除此类对象





##### 什么是联合索引？

首先，要理解最左匹配原则，得先知道什么是联合索引。

单列索引：只针对一个表列创建的索引。例如，为 users 表的 name 字段创建一个索引。
联合索引：也叫复合索引，是针对多个表列创建的索引。例如，为 users 表的 (last_name, first_name) 两个字段创建一个联合索引。
这个索引的结构可以想象成类似于电话簿或字典。电话簿是先按姓氏排序，在姓氏相同的情况下，再按名字排序。你无法直接跳过姓氏，快速找到一个特定的名字。

##### 什么是最左匹配原则？

最左匹配原则指的是：在使用联合索引进行查询时，MySQL/SQL数据库从索引的最左前列开始，并且不能跳过中间的列，一直向右匹配，直到遇到范围查询（>、<、BETWEEN、LIKE）就会停止匹配。

这个原则决定了你的 SQL 查询语句是否能够使用以及如何高效地使用这个联合索引。

##### 核心要点：

从左到右：索引的使用必须从最左边的列开始。
不能跳过：不能跳过联合索引中的某个列去使用后面的列。
范围查询右停止：如果某一列使用了范围查询，那么它右边的列将无法使用索引进行进一步筛选。
举例说明
假设我们有一个 users 表，并创建了一个联合索引 idx_name_age，包含 (last_name, age) 两个字段。

![image-20251104232733383](C:\Users\michael\AppData\Roaming\Typora\typora-user-images\image-20251104232733383.png)

索引 idx_name_age 在磁盘上大致是这样排序的（先按 last_name 排序，last_name 相同再按 age 排序）：

(Li, 30)
(Wang, 20)
(Wang, 22)
(Zhang, 25)
(Zhang, 28)



现在，我们来看不同的查询场景：

###### ✅ 场景一：完全匹配最左列

```
SELECT * FROM users WHERE last_name = 'Wang';
```

分析：查询条件包含了索引的最左列 last_name。
索引使用情况：✅ 可以使用索引。数据库可以快速在索引树中找到所有 last_name = 'Wang' 的记录（(Wang, 20) 和 (Wang, 22)）。



###### ✅ 场景二：匹配所有列

```
SELECT * FROM users WHERE last_name = 'Wang' AND age = 22;
```

分析：查询条件包含了索引的所有列，并且顺序与索引定义一致。
索引使用情况：✅ 可以高效使用索引。数据库先定位到 last_name = 'Wang'，然后在这些结果中快速找到 age = 22 的记录。

###### ✅ 场景三：匹配最左连续列

```
SELECT * FROM users WHERE last_name = 'Zhang';
```

分析：虽然只用了 last_name，但它是索引的最左列。
索引使用情况：✅ 可以使用索引。和场景一类似。



###### ❌ 场景四：跳过最左列

```
SELECT * FROM users WHERE age = 25;
```

分析：查询条件没有包含索引的最左列 last_name。
索引使用情况：❌ 无法使用索引。这就像让你在电话簿里直接找所有叫“伟”的人，你必须翻遍整个电话簿，也就是全表扫描。



###### ⚠️ 场景五：包含最左列，但中间有断档

```
-- 假设我们有一个三个字段的索引 (col1, col2, col3)
-- 查询条件为 WHERE col1 = 'a' AND col3 = 'c';
```

分析：虽然包含了最左列 col1，但跳过了 col2 直接查询 col3。
索引使用情况：✅ 部分使用索引。数据库只能使用 col1 来缩小范围，找到所有 col1 = 'a' 的记录。对于 col3 的过滤，它无法利用索引，需要在第一步的结果集中进行逐行筛选。



###### ⚠️ 场景六：最左列是范围查询

```
SELECT * FROM users WHERE last_name > 'Li' AND age = 25;
```

分析：最左列 last_name 使用了范围查询 >。
索引使用情况：✅ 部分使用索引。数据库可以使用索引找到所有 last_name > 'Li' 的记录（即从 Wang 开始往后的所有记录）。但是，对于 age = 25 这个条件，由于 last_name 已经是范围匹配，age 列在索引中是无序的，因此数据库无法再利用索引对 age 进行快速筛选，只能在 last_name > 'Li' 的结果集中逐行检查 age。



##### 总结与最佳实践

最左匹配原则的本质是由索引的数据结构（B+Tree） 决定的。索引按照定义的字段顺序构建，所以必须从最左边开始才能利用其有序性。

如何设计好的联合索引？

- 高频查询优先：将最常用于 WHERE 子句的列放在最左边。
- 等值查询优先：将经常进行等值查询（=）的列放在范围查询（>， <， LIKE）的列左边。
- 覆盖索引：如果查询的所有字段都包含在索引中（即覆盖索引），即使不符合最左前缀，数据库也可能直接扫描索引来避免回表，但这通常发生在二级索引扫描中，效率依然不如最左匹配。
  


